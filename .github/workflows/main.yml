name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  SERVICE_NAME: isa-getkeywords-service
  REPOSITORY: isa-services

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        run: |
          IMAGE_URL="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          IMAGE_URL_LATEST="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest"

          # Build for AMD64 platform (Cloud Run requirement)
          docker buildx build --platform linux/amd64 \
            -t $IMAGE_URL \
            -t $IMAGE_URL_LATEST \
            --push .

          echo "IMAGE_URL=$IMAGE_URL" >> $GITHUB_ENV

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve \
            -var="project_id=${{ env.PROJECT_ID }}" \
            -var="region=${{ env.REGION }}" \
            -var="service_name=${{ env.SERVICE_NAME }}" \
            -var="image_url=${{ env.IMAGE_URL }}"

      - name: Get Cloud Run Service URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "SERVICE_URL=$URL" >> $GITHUB_OUTPUT

      - name: Test Cloud Run Service - Health Check
        run: |
          echo "Testing health endpoint at ${{ steps.get-url.outputs.SERVICE_URL }}"

          # Get ID token for authentication
          ID_TOKEN=$(gcloud auth print-identity-token)

          # Test health endpoint (GET /)
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $ID_TOKEN" \
            ${{ steps.get-url.outputs.SERVICE_URL }})

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response code: $HTTP_CODE"
          echo "Response body: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Health check failed with status $HTTP_CODE"
            exit 1
          fi

          echo "✓ Health check passed!"

      - name: Test Cloud Run Service - Job Execution
        run: |
          echo "Testing job execution endpoint (POST /) at ${{ steps.get-url.outputs.SERVICE_URL }}"

          # Get ID token for authentication
          ID_TOKEN=$(gcloud auth print-identity-token)

          # Test job endpoint (POST /)
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $ID_TOKEN" \
            -H "Content-Type: application/json" \
            ${{ steps.get-url.outputs.SERVICE_URL }}/)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response code: $HTTP_CODE"
          echo "Response body: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Job execution test failed with status $HTTP_CODE"
            exit 1
          fi

          # Check if response contains "OK"
          if ! echo "$BODY" | grep -q "OK"; then
            echo "Job execution test failed - expected OK status in response"
            exit 1
          fi

          echo "✓ Job execution test passed!"

      - name: View Cloud Run Logs
        if: always()
        run: |
          echo "Fetching recent logs from Cloud Run..."
          gcloud run services logs read ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --limit=30 \
            --format="value(textPayload)" || true

      - name: Deployment Summary
        if: success()
        run: |
          echo "=========================================="
          echo "✓ Deployment Successful!"
          echo "=========================================="
          echo "Service URL: ${{ steps.get-url.outputs.SERVICE_URL }}"
          echo "Image: ${{ env.IMAGE_URL }}"
          echo "Region: ${{ env.REGION }}"
          echo "Scheduler: Daily at 2 AM UTC"
          echo "=========================================="
